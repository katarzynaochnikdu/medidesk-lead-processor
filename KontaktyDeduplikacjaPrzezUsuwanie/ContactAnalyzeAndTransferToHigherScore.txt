string standalone.ContactAnalyzeAndTransferToHigherScore(String recordId,Map duplicateIdsMap)
{
// Funkcja analizuje i przenosi dane między duplikatami kontaktów, zostawiając rekord o wyższym scoringu
info "=== ANALIZA I PRZENOSZENIE KONTAKTU DO REKORDU O WYŻSZYM SCORINGU ===";
info "ID analizowanego rekordu: " + recordId;
info "Lista przekazanych duplikatów: " + duplicateIdsMap.toString();
// 1. Pobranie rekordu wejściowego do analizy
contact = zoho.crm.getRecordById("Contacts",recordId);
if(contact == null)
{
	return "❌ Błąd: Kontakt o ID " + recordId + " nie istnieje";
}
info "Pobrano kontakt wejściowy: " + contact.toString();
// Lista pól które są analizowane podczas przenoszenia danych
importantFields = {"First_Name","Last_Name","Stanowisko","Title","Kontakty_wplyw_na_zakupy"};
// 2. Identyfikacja najlepszego duplikatu na podstawie scoringu
duplikatResultStr = standalone.KontaktZnajdzNajlepszyDuplikat(recordId,duplicateIdsMap);
info "Wynik analizy duplikatów: " + duplikatResultStr;
try 
{
	duplikatResult = duplikatResultStr.toMap();
	if(duplikatResult.get("status") != "success")
	{
		return duplikatResult.get("message");
	}
	// Pobranie wyników analizy duplikatów
	bestDupId = duplikatResult.get("bestDupId");
	bestDupScore = duplikatResult.get("bestDupScore");
	targetId = duplikatResult.get("targetId");
	sourceId = duplikatResult.get("sourceId");
	info "Najlepszy duplikat: " + bestDupId + " ze scoringiem: " + bestDupScore;
	info "Rekord docelowy (target): " + targetId + ", Rekord źródłowy (source) do przeniesienia: " + sourceId;
}
catch (e)
{
	info "Błąd podczas przetwarzania wyniku KontaktZnajdzNajlepszyDuplikat: " + e;
	return "❌ Błąd podczas analizy duplikatów: " + e;
}
// 3. Pobranie pełnych danych rekordów docelowego i źródłowego
targetContact = zoho.crm.getRecordById("Contacts",targetId);
sourceContact = zoho.crm.getRecordById("Contacts",sourceId);
if(targetContact == null || sourceContact == null)
{
	return "❌ Błąd: Nie udało się pobrać rekordu docelowego lub źródłowego.";
}
// Zapisanie ID firmy z rekordu źródłowego do późniejszego wykorzystania
sourceAccountId = null;
try 
{
	if(sourceContact.get("Account_Name") != null)
	{
		sourceAccountId = sourceContact.get("Account_Name").get("id");
	}
}
catch (e)
{
	info "Błąd podczas pobierania ID firmy z rekordu źródłowego: " + e;
}
// 4. Przygotowanie mapy aktualizacji z danymi do przeniesienia
updateMapStr = standalone.KontaktPrzygotujMapDoAktualizacji(sourceId,targetId);
info "Wynik przygotowania mapy aktualizacji: " + updateMapStr;
try 
{
	updateMap = updateMapStr.toMap();
	// Sprawdzenie czy nie wystąpił błąd
	if(updateMap.containsKey("error"))
	{
		info "Błąd podczas przygotowania mapy aktualizacji: " + updateMap.get("error");
		return "❌ Błąd: " + updateMap.get("error");
	}
}
catch (e)
{
	info "Błąd podczas konwersji mapy aktualizacji: " + e;
	updateMap = Map();
}
// 5. Obsługa przenoszenia danych kontaktowych (email, telefony)
info "=== SPECJALNA OBSŁUGA EMAILI ORAZ NUMERÓW TELEFONÓW ===";
// 5.1. Przeniesienie adresów email z zachowaniem ustawień RODO
info "=== PRZENIESIENIE ADRESÓW EMAIL ===";
sourceEmails = {sourceContact.get("Email"),sourceContact.get("Secondary_Email"),sourceContact.get("Email_3")};
info "Adresy email w rekordzie źródłowym: " + sourceEmails.toString();
// Przenieś każdy email ze źródła do celu
for each  sEmail in sourceEmails
{
	if(sEmail != null && sEmail != "")
	{
		// Sprawdź, czy email ma flagę RODO
		emailRodo = false;
		// Sprawdź, które pole zawiera ten email
		if(sourceContact.get("Email") == sEmail)
		{
			emailRodo = sourceContact.get("EMail1_RODO_wyrazona_niezgoda") == true;
		}
		else if(sourceContact.get("Secondary_Email") == sEmail)
		{
			emailRodo = sourceContact.get("EMail2_RODO_wyrazona_niezgoda") == true;
		}
		else if(sourceContact.get("Email_3") == sEmail)
		{
			emailRodo = sourceContact.get("EMail3_RODO_wyrazona_niezgoda") == true;
		}
		// Dopisz email do rekordu docelowego
		emailResultStr = standalone.KontaktDopiszEmail(sEmail,emailRodo,targetId);
		info "Wynik dopisywania emaila " + sEmail + ": " + emailResultStr;
	}
}
// 5.2. Przeniesienie numerów telefonów komórkowych z zachowaniem ustawień RODO
info "=== PRZENIESIENIE NUMERÓW TELEFONÓW KOMÓRKOWYCH ===";
sourceMobilePhones = {sourceContact.get("Home_Phone"),sourceContact.get("Mobile"),sourceContact.get("Telefon_komorkowy_3")};
info "Numery telefonów komórkowych w rekordzie źródłowym: " + sourceMobilePhones.toString();
// Przenieś każdy telefon komórkowy ze źródła do celu
for each  sMobile in sourceMobilePhones
{
	if(sMobile != null && sMobile != "")
	{
		// Sprawdź, czy telefon ma flagę RODO
		mobileRodo = false;
		// Sprawdź, które pole zawiera ten telefon
		if(sourceContact.get("Home_Phone") == sMobile)
		{
			mobileRodo = sourceContact.get("Tel_kom1_RODO_wyrazona_niezgoda") == true;
		}
		else if(sourceContact.get("Mobile") == sMobile)
		{
			mobileRodo = sourceContact.get("Tel_kom2_RODO_wyrazona_niezgoda") == true;
		}
		else if(sourceContact.get("Telefon_komorkowy_3") == sMobile)
		{
			mobileRodo = sourceContact.get("Tel_kom3_RODO_wyrazona_niezgoda") == true;
		}
		// Dopisz telefon komórkowy do rekordu docelowego
		mobileResultStr = standalone.KontaktDopiszTelefonKomorkowy(sMobile,mobileRodo,targetId);
		info "Wynik dopisywania telefonu komórkowego " + sMobile + ": " + mobileResultStr;
	}
}
// 5.3. Przeniesienie numerów telefonów stacjonarnych z zachowaniem ustawień RODO i numerów wewnętrznych
info "=== PRZENIESIENIE NUMERÓW TELEFONÓW STACJONARNYCH ===";
sourceLandlinePhones = {sourceContact.get("Phone"),sourceContact.get("Other_Phone"),sourceContact.get("Telefon_stacjonarny_3")};
info "Numery telefonów stacjonarnych w rekordzie źródłowym: " + sourceLandlinePhones.toString();
// Przenieś każdy telefon stacjonarny ze źródła do celu
for each  sPhone in sourceLandlinePhones
{
	if(sPhone != null && sPhone != "")
	{
		// Sprawdź, czy telefon ma flagę RODO i numer wewnętrzny
		phoneRodo = false;
		phoneExt = "";
		// Sprawdź, które pole zawiera ten telefon
		if(sourceContact.get("Phone") == sPhone)
		{
			phoneRodo = sourceContact.get("Tel_stac1_RODO_wyrazona_niezgoda") == true;
			phoneExt = sourceContact.get("wew_tel_stac_1");
		}
		else if(sourceContact.get("Other_Phone") == sPhone)
		{
			phoneRodo = sourceContact.get("Tel_stac2_RODO_wyrazona_niezgoda") == true;
			phoneExt = sourceContact.get("wew_tel_stac_2");
		}
		else if(sourceContact.get("Telefon_stacjonarny_3") == sPhone)
		{
			phoneRodo = sourceContact.get("Tel_stac3_RODO_wyrazona_niezgoda") == true;
			phoneExt = sourceContact.get("wew_tel_stac_3");
		}
		// Dopisz telefon stacjonarny do rekordu docelowego
		phoneResultStr = standalone.KontaktDopiszTelefonStacjonarny(sPhone,phoneExt,phoneRodo,targetId);
		info "Wynik dopisywania telefonu stacjonarnego " + sPhone + ": " + phoneResultStr;
	}
}
// 6. Aktualizacja rekordu docelowego przygotowanymi danymi
info "=== AKTUALIZACJA REKORDU DOCELOWEGO ===";
if(!updateMap.isEmpty())
{
	info "Mapa aktualizacji rekordu docelowego:";
	for each  key in updateMap.keys()
	{
		info "Pole: " + key + ", Wartość: " + updateMap.get(key);
	}
	info "Aktualizuję rekord docelowy o ID: " + targetId;
	updateResp = zoho.crm.updateRecord("Contacts",targetId,updateMap);
	info "Odpowiedź z API po aktualizacji rekordu docelowego: " + updateResp.toString();
	// Sprawdzenie, czy aktualizacja się powiodła
	if(updateResp != null && updateResp.get("id") != null)
	{
		info "Aktualizacja rekordu docelowego zakończona sukcesem. ID: " + updateResp.get("id");
	}
	else
	{
		info "Błąd podczas aktualizacji rekordu docelowego: " + updateResp.toString();
	}
}
else
{
	info "Brak danych do aktualizacji w rekordzie docelowym";
}
// 7. Aktualizacja flag RODO marketingowego w rekordzie docelowym
rodoUpdateResult = standalone.ContactEmailMarketingowy(targetId);
info "Zaktualizowano flagi RODO na rekordzie docelowym: " + rodoUpdateResult;
// 8. Przeniesienie powiązań z innych modułów do rekordu docelowego
connectionsTransferResult = standalone.ContactModulesConnectionTransfer(sourceId,targetId);
info "Wynik przenoszenia powiązań: " + connectionsTransferResult;
// 9. Optymalizacja powiązania z firmą - sprawdzenie czy istnieje lepsza firma
info "=== SPRAWDZANIE NIP FIRMY W REKORDZIE DOCELOWYM ===";
targetContact = zoho.crm.getRecordById("Contacts",targetId);
// Sprawdzenie NIP firmy i ewentualne przeniesienie do lepszej firmy
if(targetContact != null && targetContact.get("Account_Name") != null)
{
	try 
	{
		oldAccountId = targetContact.get("Account_Name").get("id");
		info "Pobieranie danych firmy o ID: " + oldAccountId;
		// Pobierz dane firmy, aby sprawdzić pole Firma_NIP
		accountRecord = zoho.crm.getRecordById("Accounts",oldAccountId);
		// Sprawdź, czy Firma_NIP jest puste
		if(accountRecord != null && (accountRecord.get("Firma_NIP") == null || accountRecord.get("Firma_NIP") == ""))
		{
			info "Firma nie ma numeru NIP - sprawdzam czy istnieje lepsza firma...";
			resultStr = standalone.AccountsSprawdzCzyJestLepsza(oldAccountId);
			resultMap = resultStr.toMap();
			if(resultMap != null && resultMap.get("status") == "success")
			{
				if(resultMap.get("znalezionoLepsza") == true)
				{
					najlepszaFirmaId = resultMap.get("najlepszaFirmaId");
					info "Znaleziono lepszą firmę: " + najlepszaFirmaId + " (scoring: " + resultMap.get("najlepszyScoring") + " vs " + resultMap.get("aktualnyScoring") + ")";
					// Aktualizuj powiązanie z firmą
					updateMap = Map();
					updateMap.put("Account_Name",najlepszaFirmaId);
					updateResp = zoho.crm.updateRecord("Contacts",targetId,updateMap);
					info "Zaktualizowano powiązanie firmy w kontakcie: " + updateResp;
					// Informacja o usunięciu starej firmy (jeśli została usunięta)
					if(resultMap.containsKey("usunietoFirme") && resultMap.get("usunietoFirme") == true)
					{
						info "Stara firma została usunięta automatycznie";
					}
				}
				else
				{
					info "Nie znaleziono firmy o lepszym scoringu - pozostawiam aktualną";
				}
			}
			else if(resultMap != null)
			{
				info "Błąd podczas sprawdzania lepszej firmy: " + resultMap.get("message");
			}
			else
			{
				info "Błąd: Odpowiedź z AccountsSprawdzCzyJestLepsza nie jest poprawną mapą";
			}
		}
		else
		{
			info "Firma ma uzupełniony numer NIP: " + accountRecord.get("Firma_NIP") + " - pomijam sprawdzanie lepszej firmy";
		}
	}
	catch (e)
	{
		info "Błąd podczas pobierania danych firmy: " + e;
	}
}
else
{
	info "Rekord docelowy nie ma przypisanej firmy - pomijam sprawdzanie lepszej firmy";
}
// 10. Usunięcie rekordu źródłowego po przeniesieniu wszystkich danych
info "=== DANE REKORDU ŹRÓDŁOWEGO PRZED USUNIĘCIEM ===";
response = standalone.KontaktHistoriaScalen(sourceId,targetId);
sourceContactFinal = zoho.crm.getRecordById("Contacts",sourceId);
info sourceContactFinal.toString();
info "============================================";
cleanDeleteResult = standalone.ContactCleanAndDelete(sourceId);
info "Wynik czyszczenia i usuwania rekordu źródłowego: " + cleanDeleteResult;
return "✅ Przeniesienie zakończone sukcesem. Rekord " + sourceId + " został przeniesiony do " + targetId + " i usunięty.";
}